name: 1. Scrape ESPN

on:
  schedule:
    - cron: '0 6 * * 1'  # Monday 6 AM UTC (after weekend fights)
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode with 24 fighters (faster)'
        required: false
        default: true
        type: boolean
      fighters_file:
        description: 'Path to fighters CSV file'
        required: false
        default: 'data/fighters_name.csv'
        type: string

jobs:
  scrape-espn:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verify fighters list
      run: |
        echo "🔍 Checking fighters list..."
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          FIGHTERS_FILE="data/test_fighters_list.csv"
          echo "🧪 TEST MODE: Using test_fighters_list.csv (24 fighters)"
        else
          FIGHTERS_FILE="${{ github.event.inputs.fighters_file }}"
          echo "🚀 FULL MODE: Using $FIGHTERS_FILE"
        fi
        
        if [ -f "$FIGHTERS_FILE" ]; then
          echo "✅ Found $FIGHTERS_FILE"
          echo "📊 Fighter count: $(wc -l < $FIGHTERS_FILE) fighters"
          head -5 "$FIGHTERS_FILE"
        else
          echo "❌ $FIGHTERS_FILE not found"
          exit 1
        fi
        
    - name: Run ESPN Scraper
      run: |
        echo "🎯 Starting ESPN Scraper at $(date)"
        
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "🧪 TEST MODE: Processing 24 fighters for faster troubleshooting"
          echo "📋 This will scrape:"
          echo "   ✅ HTML Files (complete ESPN pages)"
          echo "   ✅ Test mode with reduced load"
          echo ""
          python test_small_fighter_list.py
        else
          echo "🚀 FULL MODE: Processing all fighters"
          echo "📋 This will scrape:"
          echo "   ✅ HTML Files (complete ESPN pages)"
          echo "   ✅ All fighters from ${{ github.event.inputs.fighters_file }}"
          echo ""
          python test_small_fighter_list.py
        fi
        
        echo "✅ ESPN Scraper completed at $(date)"
        
    - name: Verify HTML files
      run: |
        echo "🔍 Verifying HTML files..."
        echo ""
        
        if [ -d "data/FighterHTMLs" ]; then
          html_count=$(find data/FighterHTMLs -name "*.html" | wc -l)
          echo "📁 HTML files: $html_count"
          
          # Check for small files
          small_files=$(find data/FighterHTMLs -name "*.html" -size -5k | wc -l)
          if [ $small_files -eq 0 ]; then
            echo "✅ No small HTML files (<5KB) found"
          else
            echo "⚠️  Found $small_files small HTML files (<5KB)"
          fi
          
          # Show recent files
          echo ""
          echo "📋 Recent HTML files:"
          find data/FighterHTMLs -name "*.html" -newer data/FighterHTMLs/. -exec basename {} \; | head -10
        else
          echo "❌ FighterHTMLs directory not found"
        fi
        
    - name: Commit and push HTML files
      run: |
        echo "🚀 Committing HTML files..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add HTML files
        git add data/FighterHTMLs/ || echo "No HTML files to add"
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No new HTML files to commit"
        else
          # Commit with timestamp
          timestamp=$(date +"%Y-%m-%d %H:%M:%S")
          git commit -m "📁 ESPN Scraper: HTML files - $timestamp"
          
          # Push changes
          git push
          echo "✅ HTML files committed and pushed"
        fi
        
    - name: Summary
      run: |
        echo ""
        echo "🎯 ESPN Scraper Summary:"
        echo "📁 Repository: A1-ESPN-Profiles"
        echo "📋 Output: HTML files in data/FighterHTMLs/"
        echo "⏰ Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "🔄 Next step: Run '2. Process Living Data' workflow"
        echo "✅ Pipeline: Step 1 Complete" 