name: Manual Full ESPN Scrape
on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode with 24 fighters (faster)'
        required: false
        default: true
        type: boolean

jobs:
  full-espn-scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # CRITICAL - without this, commits fail
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verify fighters list
      run: |
        echo "ğŸ” Checking fighters list..."
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "ğŸ§ª TEST MODE: Using test_fighters_list.csv (24 fighters)"
          if [ -f "data/test_fighters_list.csv" ]; then
            echo "âœ… Found test_fighters_list.csv"
            echo "ğŸ“Š Fighter count: $(wc -l < data/test_fighters_list.csv) fighters"
            head -5 data/test_fighters_list.csv
          else
            echo "âŒ test_fighters_list.csv not found"
            exit 1
          fi
        else
          echo "ğŸš€ FULL MODE: Using fighters_name.csv (621 fighters)"
          if [ -f "data/fighters_name.csv" ]; then
            echo "âœ… Found fighters_name.csv"
            echo "ğŸ“Š Fighter count: $(wc -l < data/fighters_name.csv) fighters"
            head -5 data/fighters_name.csv
          else
            echo "âŒ fighters_name.csv not found - please run pull-fighters-list workflow first"
            exit 1
          fi
        fi
        
    - name: Run ESPN Scrape
      run: |
        echo "ğŸš€ Starting ESPN Scrape at $(date)"
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "ğŸ§ª TEST MODE: Processing 24 fighters for faster troubleshooting"
          echo "ğŸ“‹ This will scrape:"
          echo "   âœ… Fighter Profiles (basic info, records, stats)"
          echo "   âœ… Test mode with reduced load"
          echo ""
          python final_espn_processor.py --test
        else
          echo "ğŸš€ FULL MODE: Processing all 621 fighters"
          echo "ğŸ“‹ This will scrape:"
          echo "   âœ… Fighter Profiles (basic info, records, stats)"
          echo "   âœ… Clinch Data (clinch striking, grappling)"
          echo "   âœ… Ground Data (ground fighting stats)"
          echo "   âœ… Striking Data (distance striking stats)"
          echo "   âœ… HTML Files (complete ESPN pages)"
          echo ""
          python run_espn_processor.py --data-type all
        fi
        
        echo "âœ… ESPN Scrape completed at $(date)"
        
    - name: Verify output files
      run: |
        echo "ğŸ” Verifying output files..."
        echo ""
        
        # Check HTML files
        if [ -d "data/FighterHTMLs" ]; then
          html_count=$(find data/FighterHTMLs -name "*.html" | wc -l)
          echo "ğŸ“ HTML files: $html_count"
          
          # Check for small files
          small_files=$(find data/FighterHTMLs -name "*.html" -size -5k | wc -l)
          if [ $small_files -eq 0 ]; then
            echo "âœ… No small HTML files (<5KB) found"
          else
            echo "âš ï¸  Found $small_files small HTML files (<5KB)"
          fi
        else
          echo "âŒ FighterHTMLs directory not found"
        fi
        
        # Check CSV files
        echo ""
        echo "ğŸ“Š CSV Output Files:"
        for file in data/*.csv; do
          if [ -f "$file" ]; then
            size=$(ls -lh "$file" | awk '{print $5}')
            lines=$(wc -l < "$file")
            echo "   $(basename "$file"): $lines lines ($size)"
          fi
        done
        
    - name: Check for changes
      id: check_changes
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "no_changes=true" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "no_changes=false" >> $GITHUB_OUTPUT
          echo "Changes detected - will commit"
        fi
        
    - name: Commit and push changes
      if: steps.check_changes.outputs.no_changes == 'false'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "Full ESPN scrape with all data types - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        git push
        
    - name: No changes notification
      if: steps.check_changes.outputs.no_changes == 'true'
      run: |
        echo "âœ… No changes detected - data is up to date"
        
    - name: Summary
      run: |
        echo ""
        echo "ğŸ¯ ESPN Scrape Summary:"
        echo "ğŸ“ Repository: A1-ESPN-Profiles"
        echo "ğŸ“‹ Data Types: Profiles, Clinch, Ground, Striking, HTML"
        echo "â° Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "âœ… Pipeline: Complete" 